{{- /* Chezmoi configuration template */ -}}
{{- /* This template selectively imports only secrets from external_secrets submodule */ -}}
{{- /* Age public key: age1wuc38w6748e7l0za4v5paccs9muasjuuqrdqq8npqyxl0dfseclsfh386e */ -}}

{{- $ageKeyPath := joinPath .chezmoi.homeDir ".config/chezmoi/key.txt" -}}
{{- $secretsEncrypted := joinPath .chezmoi.sourceDir "external_secrets/chezmoi-secrets.toml.age" -}}

{{- /* Prompt for age key if it doesn't exist and write it to disk */ -}}
{{- if not (stat $ageKeyPath) -}}
{{-   $ageKey := promptStringOnce . "age_private_key" "Enter your age private key (AGE-SECRET-KEY-...)" -}}
{{-   output "sh" "-c" (printf "mkdir -p '%s' && printf '%%s' '%s' > '%s' && chmod 600 '%s'" (dir $ageKeyPath) $ageKey $ageKeyPath $ageKeyPath) -}}
{{- end }}

encryption = "age"

[data]
    email = "me@shanemcd.com"
    name = "Shane McDonald"

[data.machine]
    type = "{{ .chezmoi.os }}"

{{ if and (stat $secretsEncrypted) (stat $ageKeyPath) -}}
{{- /* Decrypt secrets file and extract only the [data.secrets] section */ -}}
{{- $secretsContent := output "age" "-d" "-i" $ageKeyPath $secretsEncrypted | trim -}}
{{- $secretsData := $secretsContent | fromToml }}

[data.secrets]
{{ $secretsData.data.secrets | toToml | trim }}
{{- else }}
{{- /* Secrets not available - using placeholders */ -}}
[data.secrets]
    anthropic_vertex_project_id = "your-project-id"
    google_cloud_project = "your-project-id"
{{- end }}

[edit]
    command = "emacs"

[git]
    autoCommit = false
    autoPush = false

[update]
    command = "git"
    args = ["pull", "--autostash", "--recurse-submodules"]

[age]
    identity = "~/.config/chezmoi/key.txt"
    recipient = "age1wuc38w6748e7l0za4v5paccs9muasjuuqrdqq8npqyxl0dfseclsfh386e"

[diff]
    exclude = ["scripts"]

# Auto-update external_secrets submodule to latest remote (only on init/update)
[hooks.read-source-state.pre]
    command = "bash"
    args = ["{{ .chezmoi.sourceDir }}/.hooks/update-submodule.sh"]
